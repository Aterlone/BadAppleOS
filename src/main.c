#include <stdint.h>
#include <stddef.h>
#include <stdbool.h>
#include <limine.h>
#include <badapple_ascii.h>
#include <string.h>

extern unsigned char badapple_ascii_txt[];
extern unsigned int badapple_ascii_txt_len;

static const uint8_t font8x8_basic[95][8] = {
    /* ' ' 0x20 */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00},
    /* '!' 0x21 */ {0x18,0x3C,0x3C,0x18,0x18,0x00,0x18,0x00},
    /* '"' 0x22 */ {0x36,0x36,0x24,0x00,0x00,0x00,0x00,0x00},
    /* '#' 0x23 */ {0x36,0x36,0x7F,0x36,0x7F,0x36,0x36,0x00},
    /* '$' 0x24 */ {0x0C,0x3E,0x03,0x1E,0x30,0x1F,0x0C,0x00},
    /* '%' 0x25 */ {0x00,0x63,0x33,0x18,0x0C,0x66,0x63,0x00},
    /* '&' 0x26 */ {0x1C,0x36,0x1C,0x6E,0x3B,0x33,0x6E,0x00},
    /* ''' 0x27 */ {0x06,0x06,0x03,0x00,0x00,0x00,0x00,0x00},
    /* '(' 0x28 */ {0x18,0x0C,0x06,0x06,0x06,0x0C,0x18,0x00},
    /* ')' 0x29 */ {0x06,0x0C,0x18,0x18,0x18,0x0C,0x06,0x00},
    /* '*' 0x2A */ {0x00,0x66,0x3C,0xFF,0x3C,0x66,0x00,0x00},
    /* '+' 0x2B */ {0x00,0x0C,0x0C,0x3F,0x0C,0x0C,0x00,0x00},
    /* ',' 0x2C */ {0x00,0x00,0x00,0x00,0x0C,0x0C,0x06,0x00},
    /* '-' 0x2D */ {0x00,0x00,0x00,0x3F,0x00,0x00,0x00,0x00},
    /* '.' 0x2E */ {0x00,0x00,0x00,0x00,0x0C,0x0C,0x00,0x00},
    /* '/' 0x2F */ {0x60,0x30,0x18,0x0C,0x06,0x03,0x01,0x00},
    /* '0' 0x30 */ {0x3E,0x63,0x73,0x7B,0x6F,0x67,0x3E,0x00},
    /* '1' 0x31 */ {0x0C,0x0E,0x0F,0x0C,0x0C,0x0C,0x3F,0x00},
    /* '2' 0x32 */ {0x1E,0x33,0x30,0x1C,0x06,0x33,0x3F,0x00},
    /* '3' 0x33 */ {0x1E,0x33,0x30,0x1C,0x30,0x33,0x1E,0x00},
    /* '4' 0x34 */ {0x38,0x3C,0x36,0x33,0x7F,0x30,0x78,0x00},
    /* '5' 0x35 */ {0x3F,0x03,0x1F,0x30,0x30,0x33,0x1E,0x00},
    /* '6' 0x36 */ {0x1C,0x06,0x03,0x1F,0x33,0x33,0x1E,0x00},
    /* '7' 0x37 */ {0x3F,0x33,0x30,0x18,0x0C,0x0C,0x0C,0x00},
    /* '8' 0x38 */ {0x1E,0x33,0x33,0x1E,0x33,0x33,0x1E,0x00},
    /* '9' 0x39 */ {0x1E,0x33,0x33,0x3E,0x30,0x18,0x0E,0x00},
    /* ':' 0x3A */ {0x00,0x0C,0x0C,0x00,0x0C,0x0C,0x00,0x00},
    /* ';' 0x3B */ {0x00,0x0C,0x0C,0x00,0x0C,0x0C,0x06,0x00},
    /* '<' 0x3C */ {0x18,0x0C,0x06,0x03,0x06,0x0C,0x18,0x00},
    /* '=' 0x3D */ {0x00,0x00,0x3F,0x00,0x3F,0x00,0x00,0x00},
    /* '>' 0x3E */ {0x06,0x0C,0x18,0x30,0x18,0x0C,0x06,0x00},
    /* '?' 0x3F */ {0x1E,0x33,0x30,0x18,0x0C,0x00,0x0C,0x00},
    /* '@' 0x40 */ {0x3E,0x63,0x7B,0x7B,0x7B,0x03,0x1E,0x00},
    /* 'A' 0x41 */ {0x0C,0x1E,0x33,0x33,0x3F,0x33,0x33,0x00},
    /* 'B' 0x42 */ {0x3F,0x66,0x66,0x3E,0x66,0x66,0x3F,0x00},
    /* 'C' 0x43 */ {0x3C,0x66,0x03,0x03,0x03,0x66,0x3C,0x00},
    /* 'D' 0x44 */ {0x1F,0x36,0x66,0x66,0x66,0x36,0x1F,0x00},
    /* 'E' 0x45 */ {0x7F,0x46,0x16,0x1E,0x16,0x46,0x7F,0x00},
    /* 'F' 0x46 */ {0x7F,0x46,0x16,0x1E,0x16,0x06,0x0F,0x00},
    /* 'G' 0x47 */ {0x3C,0x66,0x03,0x03,0x73,0x66,0x7C,0x00},
    /* 'H' 0x48 */ {0x33,0x33,0x33,0x3F,0x33,0x33,0x33,0x00},
    /* 'I' 0x49 */ {0x1E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    /* 'J' 0x4A */ {0x78,0x30,0x30,0x30,0x33,0x33,0x1E,0x00},
    /* 'K' 0x4B */ {0x67,0x66,0x36,0x1E,0x36,0x66,0x67,0x00},
    /* 'L' 0x4C */ {0x0F,0x06,0x06,0x06,0x46,0x66,0x7F,0x00},
    /* 'M' 0x4D */ {0x63,0x77,0x7F,0x7F,0x6B,0x63,0x63,0x00},
    /* 'N' 0x4E */ {0x63,0x67,0x6F,0x7B,0x73,0x63,0x63,0x00},
    /* 'O' 0x4F */ {0x1C,0x36,0x63,0x63,0x63,0x36,0x1C,0x00},
    /* 'P' 0x50 */ {0x3F,0x66,0x66,0x3F,0x06,0x06,0x0F,0x00},
    /* 'Q' 0x51 */ {0x1E,0x33,0x33,0x33,0x3B,0x1E,0x38,0x00},
    /* 'R' 0x52 */ {0x3F,0x66,0x66,0x3F,0x36,0x66,0x67,0x00},
    /* 'S' 0x53 */ {0x1E,0x33,0x07,0x0E,0x38,0x33,0x1E,0x00},
    /* 'T' 0x54 */ {0x3F,0x2D,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    /* 'U' 0x55 */ {0x33,0x33,0x33,0x33,0x33,0x33,0x3F,0x00},
    /* 'V' 0x56 */ {0x33,0x33,0x33,0x33,0x33,0x1E,0x0C,0x00},
    /* 'W' 0x57 */ {0x63,0x63,0x6B,0x7F,0x7F,0x77,0x63,0x00},
    /* 'X' 0x58 */ {0x63,0x63,0x36,0x1C,0x1C,0x36,0x63,0x00},
    /* 'Y' 0x59 */ {0x33,0x33,0x33,0x1E,0x0C,0x0C,0x1E,0x00},
    /* 'Z' 0x5A */ {0x7F,0x63,0x31,0x18,0x4C,0x66,0x7F,0x00},
    /* '[' 0x5B */ {0x1E,0x06,0x06,0x06,0x06,0x06,0x1E,0x00},
    /* '\' 0x5C */ {0x03,0x06,0x0C,0x18,0x30,0x60,0x40,0x00},
    /* ']' 0x5D */ {0x1E,0x18,0x18,0x18,0x18,0x18,0x1E,0x00},
    /* '^' 0x5E */ {0x08,0x1C,0x36,0x63,0x00,0x00,0x00,0x00},
    /* '_' 0x5F */ {0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFF},
    /* '`' 0x60 */ {0x0C,0x0C,0x18,0x00,0x00,0x00,0x00,0x00},
    /* 'a' 0x61 */ {0x00,0x00,0x1E,0x30,0x3E,0x33,0x6E,0x00},
    /* 'b' 0x62 */ {0x07,0x06,0x06,0x3E,0x66,0x66,0x3B,0x00},
    /* 'c' 0x63 */ {0x00,0x00,0x1E,0x33,0x03,0x33,0x1E,0x00},
    /* 'd' 0x64 */ {0x38,0x30,0x30,0x3E,0x33,0x33,0x6E,0x00},
    /* 'e' 0x65 */ {0x00,0x00,0x1E,0x33,0x3F,0x03,0x1E,0x00},
    /* 'f' 0x66 */ {0x1C,0x36,0x06,0x0F,0x06,0x06,0x0F,0x00},
    /* 'g' 0x67 */ {0x00,0x00,0x6E,0x33,0x33,0x3E,0x30,0x1F},
    /* 'h' 0x68 */ {0x07,0x06,0x36,0x6E,0x66,0x66,0x67,0x00},
    /* 'i' 0x69 */ {0x0C,0x00,0x0E,0x0C,0x0C,0x0C,0x1E,0x00},
    /* 'j' 0x6A */ {0x30,0x00,0x38,0x30,0x30,0x33,0x33,0x1E},
    /* 'k' 0x6B */ {0x07,0x06,0x66,0x36,0x1E,0x36,0x67,0x00},
    /* 'l' 0x6C */ {0x0E,0x0C,0x0C,0x0C,0x0C,0x0C,0x1E,0x00},
    /* 'm' 0x6D */ {0x00,0x00,0x33,0x7F,0x7F,0x6B,0x63,0x00},
    /* 'n' 0x6E */ {0x00,0x00,0x1F,0x33,0x33,0x33,0x33,0x00},
    /* 'o' 0x6F */ {0x00,0x00,0x1E,0x33,0x33,0x33,0x1E,0x00},
    /* 'p' 0x70 */ {0x00,0x00,0x3B,0x66,0x66,0x3E,0x06,0x0F},
    /* 'q' 0x71 */ {0x00,0x00,0x6E,0x33,0x33,0x3E,0x30,0x78},
    /* 'r' 0x72 */ {0x00,0x00,0x1B,0x36,0x06,0x06,0x0F,0x00},
    /* 's' 0x73 */ {0x00,0x00,0x3E,0x03,0x1E,0x30,0x1F,0x00},
    /* 't' 0x74 */ {0x08,0x0C,0x3E,0x0C,0x0C,0x2C,0x18,0x00},
    /* 'u' 0x75 */ {0x00,0x00,0x33,0x33,0x33,0x33,0x6E,0x00},
    /* 'v' 0x76 */ {0x00,0x00,0x33,0x33,0x33,0x1E,0x0C,0x00},
    /* 'w' 0x77 */ {0x00,0x00,0x63,0x6B,0x7F,0x7F,0x36,0x00},
    /* 'x' 0x78 */ {0x00,0x00,0x63,0x36,0x1C,0x36,0x63,0x00},
    /* 'y' 0x79 */ {0x00,0x00,0x33,0x33,0x33,0x3E,0x30,0x1F},
    /* 'z' 0x7A */ {0x00,0x00,0x3F,0x19,0x0C,0x26,0x3F,0x00},
    /* '{' 0x7B */ {0x38,0x0C,0x0C,0x07,0x0C,0x0C,0x38,0x00},
    /* '|' 0x7C */ {0x0C,0x0C,0x0C,0x00,0x0C,0x0C,0x0C,0x00},
    /* '}' 0x7D */ {0x07,0x0C,0x0C,0x38,0x0C,0x0C,0x07,0x00},
    /* '~' 0x7E */ {0x6E,0x3B,0x00,0x00,0x00,0x00,0x00,0x00},
};

__attribute__((used, section(".limine_requests")))
static volatile LIMINE_BASE_REVISION(3);

__attribute__((used, section(".limine_requests")))
static volatile struct limine_framebuffer_request framebuffer_request = {
    .id = LIMINE_FRAMEBUFFER_REQUEST,
    .revision = 0
};

__attribute__((used, section(".limine_requests_start")))
static volatile LIMINE_REQUESTS_START_MARKER;

__attribute__((used, section(".limine_requests_end")))
static volatile LIMINE_REQUESTS_END_MARKER;

static void hcf(void) {
    for (;;) {
        asm("hlt");
    }
}

void *memcpy(void *dest, const void *src, size_t n) {
    uint8_t *d = (uint8_t *)dest;
    const uint8_t *s = (const uint8_t *)src;
    for (size_t i = 0; i < n; i++) {
        d[i] = s[i];
    }
    return dest;
}


static void delay(void) {
    for (volatile int i = 0; i < 10000000; i++) { }
}

void clear_framebuffer(struct limine_framebuffer *fb, uint32_t color) {
    size_t pitch = fb->pitch / 4;      
    size_t height = fb->height;
    volatile uint32_t *fb_ptr = (volatile uint32_t *)fb->address;

    for (size_t y = 0; y < height; y++) {
        for (size_t x = 0; x < pitch; x++) {
            fb_ptr[y * pitch + x] = color;
        }
    }
}

void draw_char(struct limine_framebuffer *fb, char c, size_t x, size_t y, uint32_t color) {
    if (c < 0x20 || c > 0x7E)
        return;

    size_t pitch = fb->pitch / 4; 
    volatile uint32_t *fb_ptr = (volatile uint32_t *)fb->address;

    const uint8_t *glyph = font8x8_basic[c - 0x20];

    for (int row = 0; row < 8; row++) {
        uint8_t bits = glyph[row];
        for (int col = 0; col < 8; col++) {
            if (bits & (1 << (7 - col))) {
                size_t pixel_index = (y + row) * pitch + (x + col);
                fb_ptr[pixel_index] = color;
            }
        }
    }
}


void draw_frame(struct limine_framebuffer *fb, const char *frame, size_t x, size_t y, uint32_t color) {
    size_t orig_x = x;

    while (*frame) {
        char c = *frame++;
        if (c == '\n') {
            y += 8;
            x = orig_x;
            continue;
        }
        if (c != ' ') {
            draw_char(fb, c, x, y, color);
        }
        x += 8;
    }
}

void animate_badapple(struct limine_framebuffer *fb) {
    const char *ptr = (const char *)badapple_ascii_txt;
    const char *end = ptr + badapple_ascii_txt_len;

    while (ptr < end) {
        const char *frame_end = ptr;
        while (frame_end < end && !(frame_end[0] == '\n' && frame_end[1] == '\n')) {
            frame_end++;
        }

        size_t frame_len = frame_end - ptr;
        char frame_buf[4096]; 
        if (frame_len > sizeof(frame_buf) - 1) frame_len = sizeof(frame_buf) - 1;

        memcpy(frame_buf, ptr, frame_len);
        frame_buf[frame_len] = '\0';

        clear_framebuffer(fb, 0x000000);
        draw_frame(fb, frame_buf, 10, 10, 0xFFFFFF);

        delay();

        ptr = frame_end + 2;
    }
}

void kmain(void) {
    if (LIMINE_BASE_REVISION_SUPPORTED == false) {
        hcf();
    }

    if (framebuffer_request.response == NULL
        || framebuffer_request.response->framebuffer_count < 1) {
        hcf();
    }

    struct limine_framebuffer *framebuffer = framebuffer_request.response->framebuffers[0];

    animate_badapple(framebuffer);

    hcf();
}
